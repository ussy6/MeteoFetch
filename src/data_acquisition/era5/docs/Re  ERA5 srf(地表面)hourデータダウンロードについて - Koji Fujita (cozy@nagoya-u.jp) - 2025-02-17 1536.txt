 Re: ERA5 srf(地表面)hourデータダウンロードについて
Subject:
Re: ERA5 srf(地表面)hourデータダウンロードについて
From:
Koji Fujita <cozy@nagoya-u.jp>
Date:
2025/02/17 15:36
To:
<glacier@cryoscience.net>
CC:
<cozy@nagoya-u.jp>, 岡田丈太郎 <okadajotaro1008@gmail.com>, "SUNAKO, Sojiro" <s_sunako667@bosai.go.jp>

岡田さん、cc皆さん、

メールでの情報共有ありがとうございます。

岡田さんご指摘の通り、今年に入ってCDSからダウンロードしたERA5のnetcdfファイルが壊れている、という問題が発生しているようです。フォーラムを除いてみましたが、困っている人がちらほらいました。ブログに書いたように、フラックス要素を別にしてダウンロードすればよいことがわかりました。

岡田さんが共有してくれたダウンロードのスクリプトも良いですが、藤田の方でも改良版を作ったので共有します。


添付したのはダウンロードするためのスクリプトです。

def_hour.py：Pythonでサブルーチンプログラムを別に用意するスタイル。年と月を指定してこのサブルーチンを呼び出せば、それぞれでフラックス要素、それ以外の要素、大気レベルの気温と等気圧面標高をダウンロードすることができます。ダウンロードする領域はこの中で指定。どの気圧面まで入手するかもこのファイルを変更する。

get_flx/sfc/pl_hour.py：それぞれを呼び出すスクリプト。皆さんダウンロードしていて、途中で止まっていることがありますよね？それを次の月から再開するのは結構面倒ですが、それに対応したスクリプトになっています。以下解説。

L7のtmで再開したい月を指定。もし、最初から始める場合は1を指定する。
L10-13で、再開年の途中の月から12月までをゲットするループ
L15-17で、次の年の1月から最後の年の12月までをゲットするループ
L19：スクリプトを中断するコマンド
L20-21：もし、一月だけ取りこぼしがあるなら、この二行を前に持っていき、実行するとよい。（前に持っていった二行の後ろに中断するコマンドを入れておくと良い）

みたいな感じです。


ncファイルから欲しいポイントの気象要素を取り出すスクリプト、岡田さんが工夫してくれましたが、フラックス要素を別のファイルに書き出すようになっていて、後でくっつける作業があるのでちょっと面倒です。

アドバイスとしては、（met_share_hour_ver1.py）L62で

nc = netCDF4.Dataset(odir + '/' + site + str(iyr) + str(mn) + 'hour_ver1.nc')

と読み込んでいるのに続いて、

flx = netCDF4.Dataset(odir + '/' + site + str(iyr) + str(mn) + 'hour_ver2.nc')

という感じで、別の配列を用意し、そこに読み込みます。

そして、ver2のスクリプトで

pr = nc['tp'][it,iy,ix] * 1000; dpr[md] = dpr[md] + pr

としていた部分を

pr = flx['tp'][it,iy,ix] * 1000; dpr[md] = dpr[md] + pr（あと、srdとlrd）

とすれば、一つのスクリプトで、これまでと同じように一つのファイルに出力することができるはずです。

試してみてください。odirやsiteの名称は、ダウンロードの仕方によっては別にする必要があります。その辺は各自のお好みで。

ふじた

岡田丈太郎 wrote on 2025/02/13 8:26:
> 氷河合宿参加者 様
>
> 突然の連絡失礼します。
> 新潟大学大学院修士1年の岡田と申します。先日の氷河合宿では大変お世話になりました。
>
> 今年に入って更新された氷河合宿ブログ その４i(https://cryo-science.blogspot.com/2025/)で案内がありましたが、ERA5
> srf(地表面)hourデータダウンロードでトラブルが発生することについて対応方法を共有させていただきます。
>
> ブログにもある通り、"u10, v10, t2m, d2m, ap" と "tp, ssrd, strd"
> を別々にダウンロードするスクリプトを用意して、ダウンロードすると、それぞれのファイルを問題なく（Pythonで）読み込むことができました。
> 抽出作業も同様に、それぞれのファイルごとにおこないました。
> 使用したスクリプトを添付させていただきます。
>
> 改善点や他の解決策などがありましたら、ぜひご教示いただけますと幸いです。
> お忙しいところ恐縮ですが、何卒よろしくお願いします。
> *------------------------------------------------------------------------------------------------------*
> *岡田 丈太郎（Jotaro Okada)*
> 新潟大学大学院 自然科学研究科 環境科学専攻 フィールド科学コース 修士１年
> 〒 950-2181 新潟市西区五十嵐2の町8050番地（環境エネルギー棟413)
> *Mail*：okadajotaro1008@gmail.com

-- 
Koji Fujita
Professor, Graduate School of Environmental Studies, Nagoya University
添付ファイル:
def_hour.py	4.4 KB
get_flx_hour.py	389 バイト
get_pl_hour.py	385 バイト
get_sfc_hour.py	389 バイト